<!-- ‚úÖ SCANDIT BARCODE SCAN + AGE CHECK -->
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const startBtn = document.getElementById("scanStart");
  const stopBtn  = document.getElementById("scanStop");
  const video    = document.getElementById("scanVideo");
  const output   = document.getElementById("scanOut");

  let scanner = null;

  async function startScanner() {
    try {
      scanner = await ScanditSDK.BarcodePicker.create(video, {
        playSoundOnScan: true,
        vibrateOnScan: true,
      });

      const settings = new ScanditSDK.ScanSettings({
        enabledSymbologies: ["pdf417", "qr"],
        codeDuplicateFilter: 1000
      });
      scanner.applyScanSettings(settings);

      scanner.on("scan", (result) => {
        const code = result.barcodes[0].data;
        output.textContent = code;

        // Try to read date of birth from PDF417 (AAMVA format)
        const dobMatch = code.match(/DBB(\d{8})/); // DBBYYYYMMDD
        if (dobMatch) {
          const dobStr = dobMatch[1];
          const year  = parseInt(dobStr.slice(0,4));
          const month = parseInt(dobStr.slice(4,6)) - 1;
          const day   = parseInt(dobStr.slice(6,8));
          const birth = new Date(year, month, day);
          const today = new Date();
          const age = today.getFullYear() - birth.getFullYear() -
                      (today < new Date(today.getFullYear(), month, day) ? 1 : 0);

          if (age >= 21) {
            alert("‚úÖ Verified: Customer is 21 or older.");
            window.ID_VERIFIED = true;
          } else {
            alert("üö´ Customer is under 21. Cannot continue.");
            window.ID_VERIFIED = false;
          }
        } else {
          alert("‚ö†Ô∏è Could not read birth date from ID. Try again.");
        }
      });

    } catch (err) {
      console.error("‚ùå Scanner start failed:", err);
      alert("Camera error ‚Äì check permissions.");
    }
  }

  function stopScanner() {
    if (scanner) {
      scanner.destroy();
      scanner = null;
    }
  }

  startBtn.addEventListener("click", startScanner);
  stopBtn.addEventListener("click", stopScanner);
});
</script>
