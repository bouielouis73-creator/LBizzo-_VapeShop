document.addEventListener("DOMContentLoaded", () => {
  if (window.__LBIZZO_BOOTED__) return;
  window.__LBIZZO_BOOTED__ = true;
  console.log("‚úÖ LBizzo Vape Shop script loaded");

  // ---------- Firebase ----------
  const firebaseConfig = {
    apiKey: "AIzaSyAMSTyqnUMfyaNMEusapADjoCqSYfjZCs",
    authDomain: "lbizzodelivery.firebaseapp.com",
    projectId: "lbizzodelivery",
    storageBucket: "lbizzodelivery.firebasestorage.app",
    messagingSenderId: "614540837455",
    appId: "1:614540837455:web:42709d7b585bbdc2b8203a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  const productList = $("#product-list");
  const cartItems = $("#cart-items");
  const cartCount = $("#cart-count");
  const cartTotal = $("#cart-total");

  let cart = [];

  // ---------- AGE VERIFICATION ----------
  const ageOverlay = $("#age-overlay");
  $("#yesBtn")?.addEventListener("click", () => {
    ageOverlay.style.display = "none";
    localStorage.setItem("ageVerified", "true");
  });
  $("#noBtn")?.addEventListener("click", () => {
    alert("Sorry, you must be 21+ to enter.");
    window.location.href = "https://google.com";
  });
  if (localStorage.getItem("ageVerified") === "true") {
    ageOverlay.style.display = "none";
  }

  // ---------- LOAD PRODUCTS ----------
  async function loadProducts() {
    try {
      const snap = await db.collection("products").get();
      if (snap.empty) {
        productList.innerHTML = "<p>No products found.</p>";
        return;
      }
      productList.innerHTML = "";
      snap.forEach(async (doc) => {
        const p = doc.data();
        const card = document.createElement("div");
        card.className = "product";
        const imgURL = p.image || "https://via.placeholder.com/150?text=No+Image";
        card.innerHTML = `
          <img src="${imgURL}" alt="${p.name}" />
          <h3>${p.name}</h3>
          <p>$${p.price}</p>
          <button class="add-btn">Add to Cart</button>
        `;
        const btn = card.querySelector(".add-btn");
        btn.addEventListener("click", () => addToCart(p));
        productList.appendChild(card);
      });
    } catch (err) {
      console.error("‚ùå Error loading products:", err);
    }
  }

  loadProducts();

  // ---------- CART ----------
  function addToCart(product) {
    const existing = cart.find((p) => p.name === product.name);
    if (existing) existing.qty++;
    else cart.push({ ...product, qty: 1 });
    updateCart();
  }

  function removeFromCart(name) {
    cart = cart.filter((p) => p.name !== name);
    updateCart();
  }

  function updateCart() {
    cartItems.innerHTML = "";
    let total = 0;
    cart.forEach((p) => {
      const li = document.createElement("li");
      const sub = (p.price * p.qty);
      total += sub;
      li.innerHTML = `
        ${p.name} x${p.qty} - $${sub.toFixed(2)}
        <button class="remove-btn">‚ùå</button>
      `;
      li.querySelector(".remove-btn").addEventListener("click", () => removeFromCart(p.name));
      cartItems.appendChild(li);
    });
    cartCount.textContent = cart.length;
    cartTotal.textContent = `Total: $${total.toFixed(2)}`;
  }

  // ---------- LOYALTY STARS ----------
  function updateLoyaltyStars(count) {
    const stars = $$("#loyalty-stars .star");
    stars.forEach((s, i) => {
      s.style.color = i < count ? "#ff8c00" : "#555";
    });
    if (count >= 6) {
      alert("üéâ Congratulations! You earned a free vape!");
    }
  }

  // ---------- EMAILJS SETUP ----------
  (function() {
    emailjs.init("jUx6gEqKI1tvL7yLs"); // ‚úÖ your real Public Key
  })();

  async function sendOrderEmail(orderData) {
    const params = {
      name: orderData.name,
      phone: orderData.phone,
      address: orderData.address,
      items: orderData.items,
      total: orderData.total
    };

    try {
      await emailjs.send("service_bk310ht", "template_sbbt8blk", params); // ‚úÖ your real Service & Template IDs
      alert("‚úÖ Order sent to LBizzo ‚Äî please proceed to checkout!");
      window.location.href = "https://square.link/u/YOUR_SQUARE_LINK"; // üîß replace with your real Square link
    } catch (error) {
      console.error("‚ùå EmailJS error:", error);
      alert("‚ö†Ô∏è Could not send order. Check your EmailJS keys or internet connection.");
    }
  }

  // ---------- CHECKOUT ----------
  $("#checkout-btn").addEventListener("click", () => {
    if (cart.length === 0) {
      alert("üõí Your cart is empty!");
      return;
    }

    const total = cart.reduce((sum, p) => sum + p.price * p.qty, 0);
    const itemsList = cart.map(p => `${p.name} x${p.qty}`).join(", ");

    const orderData = {
      name: prompt("Enter your name:"),
      phone: prompt("Enter your phone number:"),
      address: prompt("Enter your address:"),
      items: itemsList,
      total: total.toFixed(2)
    };

    if (!orderData.name || !orderData.phone || !orderData.address) {
      alert("Please fill all fields before placing order.");
      return;
    }

    sendOrderEmail(orderData);
    updateLoyaltyStars(cart.length);
  });
});
